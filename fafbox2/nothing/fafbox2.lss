
fafbox2.elf:     file format elf32-avr

Sections:
Idx Name          Size      VMA       LMA       File off  Algn
  0 .data         00000002  00800100  00000374  00000408  2**0
                  CONTENTS, ALLOC, LOAD, DATA
  1 .text         00000374  00000000  00000000  00000094  2**1
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
  2 .bss          0000038b  00800102  00800102  0000040a  2**0
                  ALLOC
  3 .comment      00000030  00000000  00000000  0000040a  2**0
                  CONTENTS, READONLY
  4 .note.gnu.avr.deviceinfo 00000040  00000000  00000000  0000043c  2**2
                  CONTENTS, READONLY
  5 .debug_aranges 000000a8  00000000  00000000  00000480  2**3
                  CONTENTS, READONLY, DEBUGGING
  6 .debug_info   00000470  00000000  00000000  00000528  2**0
                  CONTENTS, READONLY, DEBUGGING
  7 .debug_abbrev 00000250  00000000  00000000  00000998  2**0
                  CONTENTS, READONLY, DEBUGGING
  8 .debug_line   00000b56  00000000  00000000  00000be8  2**0
                  CONTENTS, READONLY, DEBUGGING
  9 .debug_frame  000000bc  00000000  00000000  00001740  2**2
                  CONTENTS, READONLY, DEBUGGING
 10 .debug_str    0000025a  00000000  00000000  000017fc  2**0
                  CONTENTS, READONLY, DEBUGGING
 11 .debug_loc    000000b3  00000000  00000000  00001a56  2**0
                  CONTENTS, READONLY, DEBUGGING
 12 .debug_ranges 00000058  00000000  00000000  00001b09  2**0
                  CONTENTS, READONLY, DEBUGGING

Disassembly of section .text:

00000000 <__vectors>:
   0:	0c 94 3e 00 	jmp	0x7c	; 0x7c <__ctors_end>
   4:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
   8:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
   c:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  10:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  14:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  18:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  1c:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  20:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  24:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  28:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  2c:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  30:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  34:	0c 94 5d 00 	jmp	0xba	; 0xba <__vector_13>
  38:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  3c:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  40:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  44:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  48:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  4c:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  50:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  54:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  58:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  5c:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  60:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  64:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  68:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  6c:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  70:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  74:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>
  78:	0c 94 5b 00 	jmp	0xb6	; 0xb6 <__bad_interrupt>

0000007c <__ctors_end>:
  7c:	11 24       	eor	r1, r1
  7e:	1f be       	out	0x3f, r1	; 63
  80:	cf ef       	ldi	r28, 0xFF	; 255
  82:	d0 e1       	ldi	r29, 0x10	; 16
  84:	de bf       	out	0x3e, r29	; 62
  86:	cd bf       	out	0x3d, r28	; 61

00000088 <__do_copy_data>:
  88:	11 e0       	ldi	r17, 0x01	; 1
  8a:	a0 e0       	ldi	r26, 0x00	; 0
  8c:	b1 e0       	ldi	r27, 0x01	; 1
  8e:	e4 e7       	ldi	r30, 0x74	; 116
  90:	f3 e0       	ldi	r31, 0x03	; 3
  92:	02 c0       	rjmp	.+4      	; 0x98 <__do_copy_data+0x10>
  94:	05 90       	lpm	r0, Z+
  96:	0d 92       	st	X+, r0
  98:	a2 30       	cpi	r26, 0x02	; 2
  9a:	b1 07       	cpc	r27, r17
  9c:	d9 f7       	brne	.-10     	; 0x94 <__do_copy_data+0xc>

0000009e <__do_clear_bss>:
  9e:	24 e0       	ldi	r18, 0x04	; 4
  a0:	a2 e0       	ldi	r26, 0x02	; 2
  a2:	b1 e0       	ldi	r27, 0x01	; 1
  a4:	01 c0       	rjmp	.+2      	; 0xa8 <.do_clear_bss_start>

000000a6 <.do_clear_bss_loop>:
  a6:	1d 92       	st	X+, r1

000000a8 <.do_clear_bss_start>:
  a8:	ad 38       	cpi	r26, 0x8D	; 141
  aa:	b2 07       	cpc	r27, r18
  ac:	e1 f7       	brne	.-8      	; 0xa6 <.do_clear_bss_loop>
  ae:	0e 94 a5 01 	call	0x34a	; 0x34a <main>
  b2:	0c 94 b8 01 	jmp	0x370	; 0x370 <_exit>

000000b6 <__bad_interrupt>:
  b6:	0c 94 00 00 	jmp	0	; 0x0 <__vectors>

000000ba <__vector_13>:
.global TIMER1_COMPA_vect
TIMER1_COMPA_vect:

	//horizontal sync porch - 96 cycles

	push r16 ;2
  ba:	0f 93       	push	r16

	in r16, _SFR_IO_ADDR(SREG) ;1
  bc:	0f b7       	in	r16, 0x3f	; 63
	push r16 ;2
  be:	0f 93       	push	r16

	//adjust interrupt response time

	lds r16, _SFR_MEM_ADDR(TCNT1L) ;2
  c0:	00 91 84 00 	lds	r16, 0x0084	; 0x800084 <__TEXT_REGION_LENGTH__+0x7e0084>
	cpi r16, 16 ;1
  c4:	00 31       	cpi	r16, 0x10	; 16
	breq sixteen ;1/2
  c6:	41 f0       	breq	.+16     	; 0xd8 <sixteen>
	cpi r16, 15 ;1
  c8:	0f 30       	cpi	r16, 0x0F	; 15
	breq fifteen ;1/2
  ca:	39 f0       	breq	.+14     	; 0xda <fifteen>
	cpi r16, 14 ;1
  cc:	0e 30       	cpi	r16, 0x0E	; 14
	breq fourteen ;1/2
  ce:	31 f0       	breq	.+12     	; 0xdc <fourteen>
	cpi r16, 13 ;1
  d0:	0d 30       	cpi	r16, 0x0D	; 13
	breq thirteen ;1/2
  d2:	29 f0       	breq	.+10     	; 0xde <thirteen>
	cpi r16, 12 ;1
  d4:	0c 30       	cpi	r16, 0x0C	; 12
	breq twelve ;1/2
  d6:	21 f0       	breq	.+8      	; 0xe0 <twelve>

000000d8 <sixteen>:
	...

000000da <fifteen>:
	...

000000dc <fourteen>:
	...

000000de <thirteen>:
	...

000000e0 <twelve>:
twelve:


	//24 cycles from beginning of interrupt (including 16 cycles of HFP and 8 cycles of active pixels)

	push r17 ;2
  e0:	1f 93       	push	r17

	//26 cycles from beginning of interrupt (including 16 cycles of HFP and 10 cycles of active pixels)

	//beginning of Horizontal Sync Porch

	cbi _SFR_IO_ADDR(CONTROL_PORT), HSYNC_PIN ;2
  e2:	58 98       	cbi	0x0b, 0	; 11
	
	push LINE_COUNTER_REGISTER_HIGH ;2
  e4:	df 93       	push	r29
	push LINE_COUNTER_REGISTER_LOW ;2
  e6:	cf 93       	push	r28
	lds LINE_COUNTER_REGISTER_HIGH, faf_lineCounterHigh ;2
  e8:	d0 91 05 01 	lds	r29, 0x0105	; 0x800105 <faf_lineCounterHigh>
	lds LINE_COUNTER_REGISTER_LOW, faf_lineCounterLow ;2
  ec:	c0 91 8a 04 	lds	r28, 0x048A	; 0x80048a <faf_lineCounterLow>
	//(4) playing = true, new note = false, finish = true/false, enter = true: 50 cycles (+4) -
	//(5) playing = true, new note = false, finish = true/false, enter = false: 42 cycles +6 (from difference in enter = true/false) = 48 (+6) -
	//(6) playing = false, dont care: 19 cycles (+34) -

	//we play sound only on line 255 (lower value of line counter will go through 255 only once)
	ldi r16, 0xFF ;1
  f0:	0f ef       	ldi	r16, 0xFF	; 255
	cpse LINE_COUNTER_REGISTER_LOW, r16 ;1/3
  f2:	c0 13       	cpse	r28, r16
	jmp no_sound_update ;3
  f4:	0c 94 e6 00 	jmp	0x1cc	; 0x1cc <no_sound_update>

	push r18 ;2
  f8:	2f 93       	push	r18
	push r19 ;2
  fa:	3f 93       	push	r19
	push r30 ;2
  fc:	ef 93       	push	r30
	push r31 ;2
  fe:	ff 93       	push	r31

	sbis _SFR_IO_ADDR(GENERAL_STATUS_REGISTER), GSR_IS_PLAYING_BIT ;1/2
 100:	f4 9b       	sbis	0x1e, 4	; 30
	rjmp after_sound_update_delay ;2
 102:	3d c0       	rjmp	.+122    	; 0x17e <after_sound_update_delay>

	//14 cycles (1) (3) (4) (5)

	lds r16, faf_currentNoteFrame ;2
 104:	00 91 04 01 	lds	r16, 0x0104	; 0x800104 <faf_currentNoteFrame>
	lds r17, faf_noteDurationDivider ;2
 108:	10 91 00 01 	lds	r17, 0x0100	; 0x800100 <__data_start>
	lds r18, faf_currentNote ;2
 10c:	20 91 03 01 	lds	r18, 0x0103	; 0x800103 <faf_currentNote>
	lds r19, faf_notesCount ;2
 110:	30 91 02 01 	lds	r19, 0x0102	; 0x800102 <__data_end>

	//22 cycles (1) (3) (4) (5)

	cp r16, r17 ;1
 114:	01 17       	cp	r16, r17
	breq next_note ;1/2
 116:	31 f0       	breq	.+12     	; 0x124 <next_note>
	...
	nop ;1
	nop ;1
	nop ;1

	nop ;1
	nop ;1
 120:	00 00       	nop

	rjmp after_next_note ;2
 122:	16 c0       	rjmp	.+44     	; 0x150 <after_next_note>

00000124 <next_note>:

next_note:

	//25 cycles (1) (3)

	clr r16 ;1
 124:	00 27       	eor	r16, r16
	inc r18 ;1
 126:	23 95       	inc	r18

	cp r18, r19 ;1
 128:	23 17       	cp	r18, r19
	breq playing_finished ;1/2
 12a:	09 f0       	breq	.+2      	; 0x12e <playing_finished>
	rjmp after_next_note ;2
 12c:	11 c0       	rjmp	.+34     	; 0x150 <after_next_note>

0000012e <playing_finished>:
	...
	nop ;1
	nop ;1
	nop ;1 
	nop ;1

	clr r16 ;1
 142:	00 27       	eor	r16, r16
	sts _SFR_MEM_ADDR(TCCR2A), r16 ;2
 144:	00 93 b0 00 	sts	0x00B0, r16	; 0x8000b0 <__TEXT_REGION_LENGTH__+0x7e00b0>
	sts _SFR_MEM_ADDR(TCCR2B), r16 ;2
 148:	00 93 b1 00 	sts	0x00B1, r16	; 0x8000b1 <__TEXT_REGION_LENGTH__+0x7e00b1>
	cbi _SFR_IO_ADDR(GENERAL_STATUS_REGISTER), GSR_IS_PLAYING_BIT ;2
 14c:	f4 98       	cbi	0x1e, 4	; 30
	//no need to store not frame or note - just stop playing and exit
	rjmp after_sound_update ;2
 14e:	39 c0       	rjmp	.+114    	; 0x1c2 <after_sound_update>

00000150 <after_next_note>:

after_next_note:

	//31 cycles (1) (4) (5)

	cpi r16, 0 ;1
 150:	00 30       	cpi	r16, 0x00	; 0
	breq fill_in_new_note ;1/2
 152:	41 f0       	breq	.+16     	; 0x164 <fill_in_new_note>
	...

	nop ;1
	nop ;1
	nop ;1

	nop ;1
 160:	00 00       	nop

	rjmp after_fill_in_new_note ;2
 162:	07 c0       	rjmp	.+14     	; 0x172 <after_fill_in_new_note>

00000164 <fill_in_new_note>:

fill_in_new_note:

	//34 cycles (1) (4)

	ldi r30, lo8(faf_notes) ;1
 164:	eb e8       	ldi	r30, 0x8B	; 139
	ldi r31, hi8(faf_notes) ;1
 166:	f4 e0       	ldi	r31, 0x04	; 4

	//we do this only if r16 is 0
	add r30, r18 ;1
 168:	e2 0f       	add	r30, r18
	adc r31, r16 ;1
 16a:	f0 1f       	adc	r31, r16

	ld r19, Z ;2
 16c:	30 81       	ld	r19, Z
	sts _SFR_MEM_ADDR(OCR2A), r19 ;2
 16e:	30 93 b3 00 	sts	0x00B3, r19	; 0x8000b3 <__TEXT_REGION_LENGTH__+0x7e00b3>

00000172 <after_fill_in_new_note>:

after_fill_in_new_note:

	//42 cycles (1) (4) (5)

	inc r16 ;1
 172:	03 95       	inc	r16

	sts faf_currentNote, r18 ;2
 174:	20 93 03 01 	sts	0x0103, r18	; 0x800103 <faf_currentNote>
	sts faf_currentNoteFrame, r16 ;2
 178:	00 93 04 01 	sts	0x0104, r16	; 0x800104 <faf_currentNoteFrame>
	rjmp after_sound_update ;2
 17c:	22 c0       	rjmp	.+68     	; 0x1c2 <after_sound_update>

0000017e <after_sound_update_delay>:
	...

000001c2 <after_sound_update>:

after_sound_update:

	//49 cycles (1) (3) (4) (5) (6)

	pop r31 ;2
 1c2:	ff 91       	pop	r31
	pop r30 ;2
 1c4:	ef 91       	pop	r30
	pop r19 ;2
 1c6:	3f 91       	pop	r19
	pop r18 ;2
 1c8:	2f 91       	pop	r18

	rjmp sound_updated ;2
 1ca:	36 c0       	rjmp	.+108    	; 0x238 <sound_updated>

000001cc <no_sound_update>:
	...

00000238 <sound_updated>:

	//59 cycles (1) (3) (4) (5) (6) (7)

	//69 cycles from beginning of HSP

	sbiw LINE_COUNTER_REGISTER_LOW, 2 ;2
 238:	22 97       	sbiw	r28, 0x02	; 2
	brcs turn_vsync_on ;1/2
 23a:	18 f0       	brcs	.+6      	; 0x242 <turn_vsync_on>
	nop ;1
 23c:	00 00       	nop
	sbi _SFR_IO_ADDR(CONTROL_PORT), VSYNC_PIN ;2
 23e:	59 9a       	sbi	0x0b, 1	; 11
	rjmp skip_turn_vsync_on ;2
 240:	03 c0       	rjmp	.+6      	; 0x248 <skip_turn_vsync_on>

00000242 <turn_vsync_on>:

turn_vsync_on:
	cbi _SFR_IO_ADDR(CONTROL_PORT), VSYNC_PIN ;2
 242:	59 98       	cbi	0x0b, 1	; 11
	nop ;1
 244:	00 00       	nop
	...

00000248 <skip_turn_vsync_on>:
	nop ;1

skip_turn_vsync_on:
	adiw LINE_COUNTER_REGISTER_LOW, 2 ;2
 248:	22 96       	adiw	r28, 0x02	; 2

	//79 cycles from beginning of HSP

	ldi r17, high(35) ;1
 24a:	10 e0       	ldi	r17, 0x00	; 0
	cpi LINE_COUNTER_REGISTER_LOW, low(35) ;1
 24c:	c3 32       	cpi	r28, 0x23	; 35
	cpc r17, LINE_COUNTER_REGISTER_HIGH ;1
 24e:	1d 07       	cpc	r17, r29
	breq turn_pixels_on ;1/2
 250:	11 f0       	breq	.+4      	; 0x256 <turn_pixels_on>
	nop ;1
 252:	00 00       	nop
	rjmp skip_turn_pixels_on ;2
 254:	01 c0       	rjmp	.+2      	; 0x258 <skip_turn_pixels_on>

00000256 <turn_pixels_on>:

turn_pixels_on:
	sbi _SFR_IO_ADDR(GENERAL_STATUS_REGISTER), GSR_ACTIVE_PIXELS_BIT ;2
 256:	f0 9a       	sbi	0x1e, 0	; 30

00000258 <skip_turn_pixels_on>:

skip_turn_pixels_on:
	
	//86 cycles from beginning of HSP

	ldi r17, high(415) ;1
 258:	11 e0       	ldi	r17, 0x01	; 1
	cpi LINE_COUNTER_REGISTER_LOW, low(415) ;1
 25a:	cf 39       	cpi	r28, 0x9F	; 159
	cpc r17, LINE_COUNTER_REGISTER_HIGH ;1
 25c:	1d 07       	cpc	r17, r29
	breq turn_pixels_off ;1/2
 25e:	21 f0       	breq	.+8      	; 0x268 <turn_pixels_off>
	nop ;1
 260:	00 00       	nop
	nop ;1
 262:	00 00       	nop
	nop ;1
 264:	00 00       	nop
	rjmp skip_turn_pixels_off ;2
 266:	02 c0       	rjmp	.+4      	; 0x26c <skip_turn_pixels_off>

00000268 <turn_pixels_off>:

turn_pixels_off:
	cbi _SFR_IO_ADDR(GENERAL_STATUS_REGISTER), GSR_ACTIVE_PIXELS_BIT ;2
 268:	f0 98       	cbi	0x1e, 0	; 30
	sbi _SFR_IO_ADDR(GENERAL_STATUS_REGISTER), GSR_VBLANK_BIT ;2
 26a:	f3 9a       	sbi	0x1e, 3	; 30

0000026c <skip_turn_pixels_off>:

skip_turn_pixels_off:

	nop ;1
 26c:	00 00       	nop

	//96 cycles from beginning of HSP

	//horizontal back porch - 48 cycles

	sbi _SFR_IO_ADDR(CONTROL_PORT), HSYNC_PIN ;2
 26e:	58 9a       	sbi	0x0b, 0	; 11

	ldi r17, high(424) ;1
 270:	11 e0       	ldi	r17, 0x01	; 1
	cpi LINE_COUNTER_REGISTER_LOW, low(424) ;1
 272:	c8 3a       	cpi	r28, 0xA8	; 168
	cpc r17, LINE_COUNTER_REGISTER_HIGH ;1
 274:	1d 07       	cpc	r17, r29
	breq clear_line_counter ;1/2
 276:	29 f0       	breq	.+10     	; 0x282 <clear_line_counter>
	nop ;1
 278:	00 00       	nop
	nop ;1
 27a:	00 00       	nop
	nop ;1
 27c:	00 00       	nop
	adiw LINE_COUNTER_REGISTER_LOW, 1 ;2
 27e:	21 96       	adiw	r28, 0x01	; 1
	rjmp skip_clear_line_counter ;2
 280:	06 c0       	rjmp	.+12     	; 0x28e <skip_clear_line_counter>

00000282 <clear_line_counter>:

clear_line_counter:
	in r17, _SFR_IO_ADDR(GENERAL_STATUS_REGISTER) ;1
 282:	1e b3       	in	r17, 0x1e	; 30
	bst r17, GSR_NEW_BANK_BIT ;1
 284:	12 fb       	bst	r17, 2
	bld r17, GSR_CURRENT_BANK_BIT ;1
 286:	11 f9       	bld	r17, 1
	out _SFR_IO_ADDR(GENERAL_STATUS_REGISTER), r17 ;1
 288:	1e bb       	out	0x1e, r17	; 30
	clr LINE_COUNTER_REGISTER_LOW ;1
 28a:	cc 27       	eor	r28, r28
	clr LINE_COUNTER_REGISTER_HIGH	;1
 28c:	dd 27       	eor	r29, r29

0000028e <skip_clear_line_counter>:

	//STORE VALUES

	//CONTROL_DDR is always output - no need to store
	//CONTROL_PORT might be random so save it (i.e. OUTPUT_ENABLE_PIN pin usage during writing)
	in r17, _SFR_IO_ADDR(CONTROL_PORT) ;1
 28e:	1b b1       	in	r17, 0x0b	; 11
	push r17 ;2
 290:	1f 93       	push	r17

	//LOWER_ADDRESS_DDR is always output outside of interrupt - no need to store it (it is input only here)
	//LOWER_ADDRESS_PORT might be random so save it (i.e. during writing)
	in r16, _SFR_IO_ADDR(LOWER_ADDRESS_PORT) ;1
 292:	08 b1       	in	r16, 0x08	; 8
	push r16 ;2
 294:	0f 93       	push	r16
	
	//HIGHER_ADDRESS_DDR is always output - no need to store, only 1 pin is overriden as input when in SPI mode
	//HIGHER_ADDRESS_PORT might be random so save it (i.e. during writing)
	in r16, _SFR_IO_ADDR(HIGHER_ADDRESS_PORT) ;1
 296:	05 b1       	in	r16, 0x05	; 5
	push r16 ;2
 298:	0f 93       	push	r16

	//DATA_DDR is always output - no need to store, set as input only here during reading
	//DATA_PORT might be random so save it (i.e. during writing)
	in r16, _SFR_IO_ADDR(DATA_PORT) ;1
 29a:	02 b1       	in	r16, 0x02	; 2
	push r16 ;2
 29c:	0f 93       	push	r16
	//we do not touch HSYNC_PIN
	//we do not touch VSYNC_PIN
	//we set PERIPHERAL_ENABLE_PIN to disable for now (we will turn it on after we set all ports as input), it should be turned off anyway but whatever
	//we do not touch SOUND_PIN
	//we deselect NETWORK_ENABLE_PIN, it should be turned off anyway but whatever
	ori r17, (1<<BANK_SWITCH_PIN | 1<<WRITE_READ_ENABLE_PIN | 1<<OUTPUT_ENABLE_PIN | 1<<PERIPHERAL_ENABLE_PIN | 1<<NETWORK_ENABLE_PIN) ;1
 29e:	1c 6b       	ori	r17, 0xBC	; 188
	out _SFR_IO_ADDR(CONTROL_PORT), r17 ;1
 2a0:	1b b9       	out	0x0b, r17	; 11

	//set port as input with pull-ups, before we open controller buffer
	ldi r16, 0x00 ;1
 2a2:	00 e0       	ldi	r16, 0x00	; 0
	out _SFR_IO_ADDR(LOWER_ADDRESS_DDR), r16 ;1
 2a4:	07 b9       	out	0x07, r16	; 7
	ldi r17, 0xFF ;1
 2a6:	1f ef       	ldi	r17, 0xFF	; 255
	out _SFR_IO_ADDR(LOWER_ADDRESS_PORT), r17 ;1
 2a8:	18 b9       	out	0x08, r17	; 8

	//set port as output with all ones for now, before we open sd buffer; no need to change DDR
	out _SFR_IO_ADDR(HIGHER_ADDRESS_PORT), r17 ;1
 2aa:	15 b9       	out	0x05, r17	; 5

	

	//now we enable all peripherals
	in r17, _SFR_IO_ADDR(CONTROL_PORT) ;1
 2ac:	1b b1       	in	r17, 0x0b	; 11
	andi r17, ~(1<<PERIPHERAL_ENABLE_PIN) ;1
 2ae:	1f 7d       	andi	r17, 0xDF	; 223
	out _SFR_IO_ADDR(CONTROL_PORT), r17 ;1
 2b0:	1b b9       	out	0x0b, r17	; 11


	//READ INPUT

	in r16, CONTROLLER_PIN ;1
 2b2:	06 b5       	in	r16, 0x26	; 38
	out _SFR_IO_ADDR(CONTROLLER_STATUS_REGISTER), r16 ;1
 2b4:	0a bd       	out	0x2a, r16	; 42

	

	sbis _SFR_IO_ADDR(CONTROL_PORT), GSR_ACTIVE_PIXELS_BIT ;1/2
 2b6:	58 9b       	sbis	0x0b, 0	; 11
	rjmp no_video ;2
 2b8:	30 c0       	rjmp	.+96     	; 0x31a <no_video>

000002ba <video>:
video:	

	//38 cycles from beginning of HBP

	//now we disable all peripherals
	ori r17, (1<<PERIPHERAL_ENABLE_PIN) ;1
 2ba:	10 62       	ori	r17, 0x20	; 32
	out _SFR_IO_ADDR(CONTROL_PORT), r17 ;1
 2bc:	1b b9       	out	0x0b, r17	; 11

	//do not change data port for now
	//no need to chage higher address

	//now we turn lower back to being output
	ldi r16, 0xFF ;1
 2be:	0f ef       	ldi	r16, 0xFF	; 255
	out _SFR_IO_ADDR(LOWER_ADDRESS_DDR), r16 ;1
 2c0:	07 b9       	out	0x07, r16	; 7
	out _SFR_IO_ADDR(LOWER_ADDRESS_PORT), r16 ;1
 2c2:	08 b9       	out	0x08, r16	; 8

	//set port as floating input, to protect from short-circuit when we do reading
	ldi r16, 0 ;1
 2c4:	00 e0       	ldi	r16, 0x00	; 0
	out _SFR_IO_ADDR(DATA_DDR), r16 ;1
 2c6:	01 b9       	out	0x01, r16	; 1
	out _SFR_IO_ADDR(DATA_PORT), r16 ;1
 2c8:	02 b9       	out	0x02, r16	; 2
	//46 cycles from beginning of HBP
	//horizontal active pixels - 640 cycles

	//we copy new_bank_bit to current_bank_bit at the beginning of each frame, then we test this value to determine
	//if we should use bank 0 or 1 
	sbic _SFR_IO_ADDR(GENERAL_STATUS_REGISTER), GSR_CURRENT_BANK_BIT ;1/2 
 2ca:	f1 99       	sbic	0x1e, 1	; 30
	andi r17, ~(1<<BANK_SWITCH_PIN) ;1
 2cc:	17 7f       	andi	r17, 0xF7	; 247
	out _SFR_IO_ADDR(CONTROL_PORT), r17 ;1
 2ce:	1b b9       	out	0x0b, r17	; 11


	//TODO make sure we increment line counter in good place
	//we divide line counter by 2, to doulbe each line and display 240 lines
	mov r16, LINE_COUNTER_REGISTER_LOW ;1
 2d0:	0c 2f       	mov	r16, r28
	lsr r16 ;1
 2d2:	06 95       	lsr	r16
	cpi LINE_COUNTER_REGISTER_HIGH, 0x01 ;1
 2d4:	d1 30       	cpi	r29, 0x01	; 1
	brne highest_bit_not_set ;1/2
 2d6:	09 f4       	brne	.+2      	; 0x2da <highest_bit_not_set>
	ori r16, 0b10000000 ;1
 2d8:	00 68       	ori	r16, 0x80	; 128

000002da <highest_bit_not_set>:

highest_bit_not_set:

	out _SFR_IO_ADDR(HIGHER_ADDRESS_PORT), r16 ;1
 2da:	05 b9       	out	0x05, r16	; 5
	ldi r16, 0 ;1
 2dc:	00 e0       	ldi	r16, 0x00	; 0
	out _SFR_IO_ADDR(LOWER_ADDRESS_PORT), r16 ;1
 2de:	08 b9       	out	0x08, r16	; 8

	//starting read will open video buffer
	andi r17, ~(1<<WRITE_READ_ENABLE_PIN | 1<<OUTPUT_ENABLE_PIN) ;1
 2e0:	1b 7e       	andi	r17, 0xEB	; 235

	//12 cycles from beginning of HAP

	out _SFR_IO_ADDR(CONTROL_PORT), r17 ;1
 2e2:	1b b9       	out	0x0b, r17	; 11
	
	//256 pixels wide = 512 cycles, which leaves us with 128 cycles to do something else (64 on each end)
	inc r16 ;1
 2e4:	03 95       	inc	r16
	out _SFR_IO_ADDR(LOWER_ADDRESS_PORT), r16 ;1
 2e6:	08 b9       	out	0x08, r16	; 8
	inc r16 ;1
 2e8:	03 95       	inc	r16
	out _SFR_IO_ADDR(LOWER_ADDRESS_PORT), r16 ;1
 2ea:	08 b9       	out	0x08, r16	; 8

	//256 pixels sent
	
	//we stop reading (that will close video buffer) and outputting data
	ori r17, (1<<WRITE_READ_ENABLE_PIN | 1<<OUTPUT_ENABLE_PIN) ;1
 2ec:	14 61       	ori	r17, 0x14	; 20
	out _SFR_IO_ADDR(CONTROL_PORT), r17 ;1
 2ee:	1b b9       	out	0x0b, r17	; 11

	//return data port to output, we not have any data left on RAM pins as we disabled output
	ldi r16, 0xFF ;1
 2f0:	0f ef       	ldi	r16, 0xFF	; 255
	out _SFR_IO_ADDR(DATA_DDR), r16 ;1
 2f2:	01 b9       	out	0x01, r16	; 1

	//restore all saved/changed data
	pop r16 ;2
 2f4:	0f 91       	pop	r16
	out _SFR_IO_ADDR(DATA_PORT), r16 ;1
 2f6:	02 b9       	out	0x02, r16	; 2
	pop r16 ;2
 2f8:	0f 91       	pop	r16
	out _SFR_IO_ADDR(HIGHER_ADDRESS_PORT), r16 ;1
 2fa:	05 b9       	out	0x05, r16	; 5
	pop r16 ;2
 2fc:	0f 91       	pop	r16
	out _SFR_IO_ADDR(LOWER_ADDRESS_PORT), r16 ;1
 2fe:	08 b9       	out	0x08, r16	; 8
	pop r16 ;2
 300:	0f 91       	pop	r16
	out _SFR_IO_ADDR(CONTROL_PORT), r16 ;1
 302:	0b b9       	out	0x0b, r16	; 11

	sts faf_lineCounterLow, LINE_COUNTER_REGISTER_LOW ;2
 304:	c0 93 8a 04 	sts	0x048A, r28	; 0x80048a <faf_lineCounterLow>
	sts faf_lineCounterHigh, LINE_COUNTER_REGISTER_HIGH ;2
 308:	d0 93 05 01 	sts	0x0105, r29	; 0x800105 <faf_lineCounterHigh>
	pop LINE_COUNTER_REGISTER_LOW ;2
 30c:	cf 91       	pop	r28
	pop LINE_COUNTER_REGISTER_HIGH ;2
 30e:	df 91       	pop	r29
	pop r17 ;2
 310:	1f 91       	pop	r17
	pop r16 ;2
 312:	0f 91       	pop	r16
	out _SFR_IO_ADDR(SREG), r16 ;1
 314:	0f bf       	out	0x3f, r16	; 63
	pop r16 ;2
 316:	0f 91       	pop	r16

	reti ;4-5 ?
 318:	18 95       	reti

0000031a <no_video>:
	//38 cycles from beginning of HBP
	
	//do some reading and writing to SPI here

	//now we disable all peripherals
	ori r17, (1<<PERIPHERAL_ENABLE_PIN) ;1
 31a:	10 62       	ori	r17, 0x20	; 32
	out _SFR_IO_ADDR(CONTROL_PORT), r17 ;1
 31c:	1b b9       	out	0x0b, r17	; 11

	//do not change data port for now
	//no need to chage higher address

	//now we turn lower back to being output
	ldi r16, 0xFF ;1
 31e:	0f ef       	ldi	r16, 0xFF	; 255
	out _SFR_IO_ADDR(LOWER_ADDRESS_DDR), r16 ;1
 320:	07 b9       	out	0x07, r16	; 7
	out _SFR_IO_ADDR(LOWER_ADDRESS_PORT), r16 ;1
 322:	08 b9       	out	0x08, r16	; 8

	//restore all saved/changed data
	pop r16 ;2
 324:	0f 91       	pop	r16
	out _SFR_IO_ADDR(DATA_PORT), r16 ;1
 326:	02 b9       	out	0x02, r16	; 2
	pop r16 ;2
 328:	0f 91       	pop	r16
	out _SFR_IO_ADDR(HIGHER_ADDRESS_PORT), r16 ;1
 32a:	05 b9       	out	0x05, r16	; 5
	pop r16 ;2
 32c:	0f 91       	pop	r16
	out _SFR_IO_ADDR(LOWER_ADDRESS_PORT), r16 ;1
 32e:	08 b9       	out	0x08, r16	; 8
	pop r16 ;2
 330:	0f 91       	pop	r16
	out _SFR_IO_ADDR(CONTROL_PORT), r16 ;1
 332:	0b b9       	out	0x0b, r16	; 11


	sts faf_lineCounterLow, LINE_COUNTER_REGISTER_LOW ;2
 334:	c0 93 8a 04 	sts	0x048A, r28	; 0x80048a <faf_lineCounterLow>
	sts faf_lineCounterHigh, LINE_COUNTER_REGISTER_HIGH ;2
 338:	d0 93 05 01 	sts	0x0105, r29	; 0x800105 <faf_lineCounterHigh>
	pop LINE_COUNTER_REGISTER_LOW ;2
 33c:	cf 91       	pop	r28
	pop LINE_COUNTER_REGISTER_HIGH ;2
 33e:	df 91       	pop	r29
	pop r17 ;2
 340:	1f 91       	pop	r17
	pop r16 ;2
 342:	0f 91       	pop	r16
	out _SFR_IO_ADDR(SREG), r16 ;1
 344:	0f bf       	out	0x3f, r16	; 63
	pop r16 ;2
 346:	0f 91       	pop	r16

 348:	18 95       	reti

0000034a <main>:
#include <util/delay.h>
#include "fafbox.h"


int main(void) {
    CONTROL_DDR = 0xFF;
 34a:	8f ef       	ldi	r24, 0xFF	; 255
 34c:	8a b9       	out	0x0a, r24	; 10
	CONTROL_PORT = (1<<HSYNC_PIN | 1<<VSYNC_PIN | 1<<SOUND_PIN | 1<<PERIPHERAL_ENABLE_PIN | 1<<NETWORK_ENABLE_PIN | 1<<WRITE_READ_ENABLE_PIN | 1<<BANK_SWITCH_PIN | 1<<OUTPUT_ENABLE_PIN);
 34e:	8b b9       	out	0x0b, r24	; 11
	
	DATA_DDR = 0xFF;
 350:	81 b9       	out	0x01, r24	; 1
	DATA_PORT = 0b00001110;
 352:	9e e0       	ldi	r25, 0x0E	; 14
 354:	92 b9       	out	0x02, r25	; 2
	
	LOWER_ADDRESS_DDR = 0xFF;
 356:	87 b9       	out	0x07, r24	; 7
	LOWER_ADDRESS_PORT = 0b10101010;
 358:	9a ea       	ldi	r25, 0xAA	; 170
 35a:	98 b9       	out	0x08, r25	; 8
	
	HIGHER_ADDRESS_DDR = 0xFF;
 35c:	84 b9       	out	0x04, r24	; 4
	HIGHER_ADDRESS_PORT = 0b01010101;
 35e:	85 e5       	ldi	r24, 0x55	; 85
 360:	85 b9       	out	0x05, r24	; 5
	
	CONTROL_PORT &= ~(1<<OUTPUT_ENABLE_PIN);
 362:	5c 98       	cbi	0x0b, 4	; 11
	CONTROL_PORT |= (1<<OUTPUT_ENABLE_PIN);
 364:	5c 9a       	sbi	0x0b, 4	; 11
	
	
	DATA_DDR = 0x00;
 366:	11 b8       	out	0x01, r1	; 1
	DATA_PORT = 0x00;
 368:	12 b8       	out	0x02, r1	; 2
	
	CONTROL_PORT &= ~(1<<WRITE_READ_ENABLE_PIN);
 36a:	5a 98       	cbi	0x0b, 2	; 11
	
	CONTROL_PORT &= ~(1<<OUTPUT_ENABLE_PIN);
 36c:	5c 98       	cbi	0x0b, 4	; 11
	

    while (1) {
    }
 36e:	ff cf       	rjmp	.-2      	; 0x36e <main+0x24>

00000370 <_exit>:
 370:	f8 94       	cli

00000372 <__stop_program>:
 372:	ff cf       	rjmp	.-2      	; 0x372 <__stop_program>
